name: Deployement Workflow

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  Deploy-Docker-Infra:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy on remote server
        uses: appleboy/ssh-action@v1.2.0
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          DOMAIN: ${{ secrets.DOMAIN }}
          NETWORK_NAME: ${{ secrets.NETWORK_NAM }}
          AUTH_MIDDLEWARE: ${{ secrets.AUTH_MIDDLEWARE }}
          TZ: ${{ secrets.TZ }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          TRAEFIK_SUBDOMAIN: ${{ secrets.TRAEFIK_SUBDOMAIN }}
          TASKLIST_SUBDOMAIN: ${{ secrets.TASKLIST_SUBDOMAIN }}
          WIKI_SUBDOMAIN: ${{ secrets.WIKI_SUBDOMAIN }}
          UPTIME_SUBDOMAIN: ${{ secrets.UPTIME_SUBDOMAIN }}
          WIKI_PORT: ${{ secrets.WIKI_PORT }}
          UPTIME_PORT: ${{ secrets.UPTIME_PORT }}
          F2B_PORT: ${{ secrets.F2B_PORT }}
          FRONT_PORT: ${{ secrets.FRONT_PORT }}
          BACK_PORT: ${{ secrets.BACK_PORT }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: GH_TOKEN,DOMAIN,NETWORK_NAME,AUTH_MIDDLEWARE,TZ,DB_HOST,DB_NAME,DB_USER,DB_PASSWORD,TRAEFIK_SUBDOMAIN,TASKLIST_SUBDOMAIN,WIKI_SUBDOMAIN,UPTIME_SUBDOMAIN,WIKI_PORT,UPTIME_PORT,F2B_PORT,FRONT_PORT,BACK_PORT
          script: |
            # 1. Préparation du réseau
            docker network create ${NETWORK_NAME} || true

            # 2. Clonage et mise à jour des fichiers
            cd ~
            rm -rf temp_repo
            git clone https://x-access-token:${GH_TOKEN}@github.com/Elerig22/Serveur-Internet-Sample-Project.git temp_repo
            mkdir -p ~/srv
            cp -r ~/temp_repo/srv/* ~/srv/
            rm -rf ~/temp_repo

            # 3. Configuration et Lancement par service
            
            # --- TRAEFIK ---
            cat <<EOF > ~/srv/traefik/.env
            DOMAIN=${DOMAIN}
            NETWORK_NAME=${NETWORK_NAME}
            TRAEFIK_SUBDOMAIN=${TRAEFIK_SUBDOMAIN}
            AUTH_MIDDLEWARE=${AUTH_MIDDLEWARE}
           
            EOF
            cd ~/srv/traefik && docker compose down && docker compose up -d --build --force-recreate

            # --- TASKLIST ---
            cat <<EOF > ~/srv/tasklist/.env
            DOMAIN=${DOMAIN}
            TASKLIST_SUBDOMAIN=${TASKLIST_SUBDOMAIN}
            FRONT_PORT=${FRONT_PORT}
            BACK_PORT=${BACK_PORT}
            DB_HOST=${DB_HOST}
            DB_NAME=${DB_NAME}
            DB_USER=${DB_USER}
            DB_PASSWORD=${DB_PASSWORD}
            EOF
            cd ~/srv/tasklist && docker compose down && docker compose up -d --build --force-recreate

            # --- WIKI ---
            cat <<EOF > ~/srv/wiki/.env
            DOMAIN=${DOMAIN}
            WIKI_SUBDOMAIN=${WIKI_SUBDOMAIN}
            WIKI_PORT=${WIKI_PORT}
            EOF
            cd ~/srv/wiki && docker compose down && docker compose up -d --build --force-recreate

            # --- MONITORING ---
            cat <<EOF > ~/srv/monitoring/.env
            DOMAIN=${DOMAIN}
            UPTIME_SUBDOMAIN=${UPTIME_SUBDOMAIN}
            UPTIME_PORT=${UPTIME_PORT}
           
            EOF
            cd ~/srv/monitoring && docker compose down && docker compose up -d --build --force-recreate

            # --- FAIL2BAN ---
            cat <<EOF > ~/srv/fail2ban/.env
            DOMAIN=${DOMAIN}
            F2B_PORT=${F2B_PORT}
            F2B_SUBDOMAIN= ${F2B_SUBDOMAIN}
            TZ=${TZ}
            EOF
            cd ~/srv/fail2ban && docker compose down && docker compose up -d --build --force-recreate

            # Maintenance
            docker image prune -f
